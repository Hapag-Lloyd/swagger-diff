<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ModelDiff.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">swagger-diff</a> &gt; <a href="index.source.html" class="el_package">com.deepoove.swagger.diff.compare</a> &gt; <span class="el_source">ModelDiff.java</span></div><h1>ModelDiff.java</h1><pre class="source lang-java linenums">package com.deepoove.swagger.diff.compare;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

import com.deepoove.swagger.diff.model.ElProperty;

import io.swagger.models.ArrayModel;
import io.swagger.models.Model;
import io.swagger.models.RefModel;
import io.swagger.models.properties.ArrayProperty;
import io.swagger.models.properties.Property;
import io.swagger.models.properties.RefProperty;
import io.swagger.models.properties.StringProperty;

/**
 * compare two model
 * 
 * @author Sayi
 */
public class ModelDiff {

    private List&lt;ElProperty&gt; increased;
    private List&lt;ElProperty&gt; missing;
    private List&lt;ElProperty&gt; changed;

    Map&lt;String, Model&gt; oldDedinitions;
    Map&lt;String, Model&gt; newDedinitions;

<span class="fc" id="L36">    private ModelDiff() {</span>
<span class="fc" id="L37">        increased = new ArrayList&lt;ElProperty&gt;();</span>
<span class="fc" id="L38">        missing = new ArrayList&lt;ElProperty&gt;();</span>
<span class="fc" id="L39">        changed = new ArrayList&lt;ElProperty&gt;();</span>
<span class="fc" id="L40">    }</span>

    public static ModelDiff buildWithDefinition(Map&lt;String, Model&gt; left, Map&lt;String, Model&gt; right) {
<span class="fc" id="L43">        ModelDiff diff = new ModelDiff();</span>
<span class="fc" id="L44">        diff.oldDedinitions = left;</span>
<span class="fc" id="L45">        diff.newDedinitions = right;</span>
<span class="fc" id="L46">        return diff;</span>
    }

    public ModelDiff diff(Model leftModel, Model rightModel) {
<span class="fc" id="L50">        return this.diff(leftModel, rightModel, null, new HashSet&lt;Model&gt;());</span>
    }

    public ModelDiff diff(Model leftModel, Model rightModel, String parentEl) {
<span class="fc" id="L54">        return this.diff(leftModel, rightModel, parentEl, new HashSet&lt;Model&gt;());</span>
    }

    public ModelDiff diff(Property leftProperty, Property rightProperty) {
<span class="fc" id="L58">        return this.diff(findModel(leftProperty, oldDedinitions), findModel(rightProperty, newDedinitions));</span>
    }

    private ModelDiff diff(Model leftInputModel, Model rightInputModel, String parentEl, Set&lt;Model&gt; visited) {
        // Stop recursing if both models are null
        // OR either model is already contained in the visiting history
<span class="pc bpc" id="L64" title="1 of 6 branches missed.">        if ((null == leftInputModel &amp;&amp; null == rightInputModel) || visited.contains(leftInputModel)</span>
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">                || visited.contains(rightInputModel)) {</span>
<span class="fc" id="L66">            return this;</span>
        }
<span class="fc bfc" id="L68" title="All 2 branches covered.">        Model leftModel = isModelReference(leftInputModel) ? findReferenceModel(leftInputModel, oldDedinitions)</span>
                : leftInputModel;
<span class="fc bfc" id="L70" title="All 2 branches covered.">        Model rightModel = isModelReference(rightInputModel) ? findReferenceModel(rightInputModel, newDedinitions)</span>
                : rightInputModel;
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">        Map&lt;String, Property&gt; leftProperties = null == leftModel ? null : leftModel.getProperties();</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">        Map&lt;String, Property&gt; rightProperties = null == rightModel ? null : rightModel.getProperties();</span>

        // Diff the properties
<span class="fc" id="L76">        MapKeyDiff&lt;String, Property&gt; propertyDiff = MapKeyDiff.diff(leftProperties, rightProperties);</span>

<span class="fc" id="L78">        increased.addAll(convert2ElPropertys(propertyDiff.getIncreased(), parentEl));</span>
<span class="fc" id="L79">        missing.addAll(convert2ElPropertys(propertyDiff.getMissing(), parentEl));</span>

        // Recursively find the diff between properties
<span class="fc" id="L82">        List&lt;String&gt; sharedKey = propertyDiff.getSharedKey();</span>
<span class="fc" id="L83">        sharedKey.stream().forEach((key) -&gt; {</span>
<span class="fc" id="L84">            Property left = leftProperties.get(key);</span>
<span class="fc" id="L85">            Property right = rightProperties.get(key);</span>
<span class="fc" id="L86">            Model leftSubModel = findModel(left, oldDedinitions);</span>
<span class="fc" id="L87">            Model rightSubModel = findModel(left, newDedinitions);</span>
<span class="pc bpc" id="L88" title="1 of 4 branches missed.">            if (leftSubModel != null || rightSubModel != null) {</span>
<span class="fc" id="L89">                diff(leftSubModel, rightSubModel, buildElString(parentEl, key),</span>
<span class="fc" id="L90">                        copyAndAdd(visited, leftModel, rightModel));</span>
<span class="pc bpc" id="L91" title="2 of 6 branches missed.">            } else if (left != null &amp;&amp; right != null &amp;&amp; !left.equals(right)) {</span>
                // Add a changed ElProperty if not a Reference
                // Useless
<span class="fc" id="L94">                changed.add(addChangeMetadata(convert2ElProperty(key, parentEl, left), left, right));</span>
            }
<span class="fc" id="L96">        });</span>
<span class="fc" id="L97">        return this;</span>
    }

    private Collection&lt;? extends ElProperty&gt; convert2ElPropertys(Map&lt;String, Property&gt; propMap, String parentEl) {

<span class="fc" id="L102">        List&lt;ElProperty&gt; result = new ArrayList&lt;ElProperty&gt;();</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        if (null == propMap) return result;</span>

<span class="fc bfc" id="L105" title="All 2 branches covered.">        for (Entry&lt;String, Property&gt; entry : propMap.entrySet()) {</span>
            // TODO Recursively get the properties
<span class="fc" id="L107">            result.add(convert2ElProperty(entry.getKey(), parentEl, entry.getValue()));</span>
<span class="fc" id="L108">        }</span>
<span class="fc" id="L109">        return result;</span>
    }

    private String buildElString(String parentEl, String propName) {
<span class="fc bfc" id="L113" title="All 2 branches covered.">        return null == parentEl ? propName : (parentEl + &quot;.&quot; + propName);</span>
    }

    private ElProperty convert2ElProperty(String propName, String parentEl, Property property) {
<span class="fc" id="L117">        ElProperty pWithPath = new ElProperty();</span>
<span class="fc" id="L118">        pWithPath.setProperty(property);</span>
<span class="fc" id="L119">        pWithPath.setEl(buildElString(parentEl, propName));</span>
<span class="fc" id="L120">        return pWithPath;</span>
    }

    private ElProperty addChangeMetadata(ElProperty diffProperty, Property left, Property right) {
<span class="fc bfc" id="L124" title="All 2 branches covered.">        diffProperty.setTypeChange(!left.getType().equalsIgnoreCase(right.getType()));</span>
<span class="fc" id="L125">        List&lt;String&gt; leftEnums = enumValues(left);</span>
<span class="fc" id="L126">        List&lt;String&gt; rightEnums = enumValues(right);</span>
<span class="pc bpc" id="L127" title="1 of 4 branches missed.">        if (!leftEnums.isEmpty() &amp;&amp; !rightEnums.isEmpty()) {</span>
<span class="fc" id="L128">            ListDiff&lt;String&gt; enumDiff = ListDiff.diff(leftEnums, rightEnums, (t, enumVal) -&gt; {</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">                for (String value : t) {</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">                    if (enumVal.equalsIgnoreCase(value)) { return value; }</span>
<span class="fc" id="L131">                }</span>
<span class="fc" id="L132">                return null;</span>
            });
<span class="pc bpc" id="L134" title="2 of 4 branches missed.">            diffProperty.setNewEnums(enumDiff.getIncreased() != null &amp;&amp; !enumDiff.getIncreased().isEmpty());</span>
<span class="pc bpc" id="L135" title="2 of 4 branches missed.">            diffProperty.setRemovedEnums(enumDiff.getMissing() != null &amp;&amp; !enumDiff.getMissing().isEmpty());</span>
        }
<span class="fc" id="L137">        return diffProperty;</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private &lt;T&gt; Set&lt;T&gt; copyAndAdd(Set&lt;T&gt; set, T... add) {
<span class="fc" id="L142">        Set&lt;T&gt; newSet = new HashSet&lt;T&gt;(set);</span>
<span class="fc" id="L143">        newSet.addAll(Arrays.asList(add));</span>
<span class="fc" id="L144">        return newSet;</span>
    }

    private List&lt;String&gt; enumValues(Property prop) {
<span class="fc bfc" id="L148" title="All 4 branches covered.">        if (prop instanceof StringProperty &amp;&amp; ((StringProperty) prop).getEnum() != null) {</span>
<span class="fc" id="L149">            return ((StringProperty) prop).getEnum();</span>
        } else {
<span class="fc" id="L151">            return new ArrayList&lt;&gt;();</span>
        }
    }

    private Model findModel(Property property, Map&lt;String, Model&gt; modelMap) {
<span class="fc" id="L156">        String modelName = null;</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">        if (property instanceof RefProperty) {</span>
<span class="fc" id="L158">            modelName = ((RefProperty) property).getSimpleRef();</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">        } else if (property instanceof ArrayProperty) {</span>
<span class="fc" id="L160">            Property arrayType = ((ArrayProperty) property).getItems();</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">            if (arrayType instanceof RefProperty) {</span>
<span class="fc" id="L162">                modelName = ((RefProperty) arrayType).getSimpleRef();</span>
            }
        }
<span class="fc bfc" id="L165" title="All 2 branches covered.">        return modelName == null ? null : modelMap.get(modelName);</span>
    }

    private boolean isModelReference(Model model) {
<span class="fc bfc" id="L169" title="All 4 branches covered.">        return model instanceof RefModel || model instanceof ArrayModel;</span>
    }

    private Model findReferenceModel(Model model, Map&lt;String, Model&gt; modelMap) {
<span class="fc" id="L173">        String modelName = null;</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">        if (model instanceof RefModel) {</span>
<span class="fc" id="L175">            modelName = ((RefModel) model).getSimpleRef();</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">        } else if (model instanceof ArrayModel) {</span>
<span class="fc" id="L177">            Property arrayType = ((ArrayModel) model).getItems();</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">            if (arrayType instanceof RefProperty) {</span>
<span class="fc" id="L179">                modelName = ((RefProperty) arrayType).getSimpleRef();</span>
            }
        }
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">        return modelName == null ? null : modelMap.get(modelName);</span>
    }

    public List&lt;ElProperty&gt; getIncreased() {
<span class="fc" id="L186">        return increased;</span>
    }

    public void setIncreased(List&lt;ElProperty&gt; increased) {
<span class="nc" id="L190">        this.increased = increased;</span>
<span class="nc" id="L191">    }</span>

    public List&lt;ElProperty&gt; getMissing() {
<span class="fc" id="L194">        return missing;</span>
    }

    public void setMissing(List&lt;ElProperty&gt; missing) {
<span class="nc" id="L198">        this.missing = missing;</span>
<span class="nc" id="L199">    }</span>

    public List&lt;ElProperty&gt; getChanged() {
<span class="fc" id="L202">        return changed;</span>
    }

    public void setChanged(List&lt;ElProperty&gt; changed) {
<span class="nc" id="L206">        this.changed = changed;</span>
<span class="nc" id="L207">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>